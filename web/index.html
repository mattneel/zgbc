<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>libzetro - Multi-System Emulator</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #1a1a2e;
            color: #eee;
            font-family: system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            margin: 0;
        }
        h1 { margin-bottom: 0.5rem; }
        .subtitle { color: #666; margin-bottom: 2rem; }
        .system-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
            font-weight: bold;
        }
        .system-gb { background: #9bbc0f; color: #0f380f; }
        .system-nes { background: #c84c4c; color: #fff; }
        .system-sms { background: #0070c0; color: #fff; }
        #canvas-container {
            border: 4px solid #333;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }
        canvas {
            display: block;
            image-rendering: pixelated;
        }
        .controls {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        input[type="file"] { display: none; }
        label, button {
            background: #444;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        label:hover, button:hover { background: #666; }
        .keys {
            margin-top: 2rem;
            color: #666;
            font-size: 0.9rem;
            text-align: center;
        }
        .keys kbd {
            background: #333;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            margin: 0 0.2rem;
        }
        #fps { color: #9f9; font-family: monospace; }
        #mute.muted { background: #633; }
        .drop-zone {
            border: 2px dashed #444;
            padding: 3rem;
            text-align: center;
            border-radius: 8px;
            color: #666;
            margin-bottom: 1rem;
        }
        .drop-zone.dragover { border-color: #888; background: #222; }
        .supported { font-size: 0.8rem; color: #555; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <h1>libzetro <span id="system-badge" class="system-badge" style="display:none"></span></h1>
    <p class="subtitle">Multi-System Emulator: Game Boy + NES + SMS</p>

    <div id="drop-zone" class="drop-zone">
        Drop ROM here or click to select<br>
        <span class="supported">Supports: .gb .gbc .nes .sms</span>
    </div>

    <div id="canvas-container" style="display:none">
        <canvas id="screen"></canvas>
    </div>

    <div class="controls">
        <label for="rom">Load ROM</label>
        <input type="file" id="rom" accept=".gb,.gbc,.nes,.sms">
        <button id="mute">Sound: ON</button>
        <span id="fps">-- FPS</span>
    </div>

    <div class="keys">
        <kbd>Arrow keys</kbd> D-Pad |
        <kbd>Z</kbd> A |
        <kbd>X</kbd> B |
        <kbd>Enter</kbd> Start |
        <kbd>Shift</kbd> Select
    </div>

    <script>
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');
        const fpsEl = document.getElementById('fps');
        const muteBtn = document.getElementById('mute');
        const dropZone = document.getElementById('drop-zone');
        const canvasContainer = document.getElementById('canvas-container');
        const systemBadge = document.getElementById('system-badge');

        let wasm = null;
        let running = false;
        let buttons = 0;
        let audioCtx = null;
        let audioEnabled = true;
        let currentSystem = null; // 'gb' or 'nes'

        // System configs
        const systems = {
            gb: {
                width: 160,
                height: 144,
                scale: 3,
                init: () => wasm.gb_init(),
                loadRom: (len) => wasm.gb_loadRom(len),
                frame: () => wasm.gb_frame(),
                setInput: (b) => wasm.gb_setInput(b),
                getFrame: () => wasm.gb_getFrame(),
                getAudioSamples: () => wasm.gb_getAudioSamples(),
                label: 'Game Boy',
                class: 'system-gb'
            },
            nes: {
                width: 256,
                height: 240,
                scale: 2,
                init: () => wasm.nes_init(),
                loadRom: (len) => wasm.nes_loadRom(len),
                frame: () => wasm.nes_frame(),
                setInput: (b) => wasm.nes_setInput(b),
                getFrame: () => wasm.nes_getFrame(),
                getAudioSamples: () => wasm.nes_getAudioSamples(),
                label: 'NES',
                class: 'system-nes'
            },
            sms: {
                width: 256,
                height: 192,
                scale: 2,
                init: () => wasm.sms_init(),
                loadRom: (len) => wasm.sms_loadRom(len),
                frame: () => wasm.sms_frame(),
                setInput: (b) => wasm.sms_setInput(b),
                getFrame: () => wasm.sms_getFrame(),
                getAudioSamples: () => wasm.sms_getAudioSamples(),
                label: 'SMS',
                class: 'system-sms'
            }
        };

        // GB:  A=0, B=1, Select=2, Start=3, Right=4, Left=5, Up=6, Down=7
        // NES: A=0, B=1, Select=2, Start=3, Up=4, Down=5, Left=6, Right=7
        // SMS: Up=0, Down=1, Left=2, Right=3, B1=4, B2=5
        const keyMaps = {
            gb: {
                'z': 0, 'Z': 0,
                'x': 1, 'X': 1,
                'Shift': 2,
                'Enter': 3,
                'ArrowRight': 4,
                'ArrowLeft': 5,
                'ArrowUp': 6,
                'ArrowDown': 7
            },
            nes: {
                'z': 0, 'Z': 0,
                'x': 1, 'X': 1,
                'Shift': 2,
                'Enter': 3,
                'ArrowUp': 4,
                'ArrowDown': 5,
                'ArrowLeft': 6,
                'ArrowRight': 7
            },
            sms: {
                'ArrowUp': 0,
                'ArrowDown': 1,
                'ArrowLeft': 2,
                'ArrowRight': 3,
                'z': 4, 'Z': 4,
                'x': 5, 'X': 5
            }
        };

        document.addEventListener('keydown', e => {
            const keyMap = keyMaps[currentSystem] || keyMaps.gb;
            if (keyMap.hasOwnProperty(e.key)) {
                buttons |= (1 << keyMap[e.key]);
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', e => {
            const keyMap = keyMaps[currentSystem] || keyMaps.gb;
            if (keyMap.hasOwnProperty(e.key)) {
                buttons &= ~(1 << keyMap[e.key]);
                e.preventDefault();
            }
        });

        muteBtn.addEventListener('click', () => {
            audioEnabled = !audioEnabled;
            muteBtn.textContent = audioEnabled ? 'Sound: ON' : 'Sound: OFF';
            muteBtn.classList.toggle('muted', !audioEnabled);
        });

        // Drag and drop
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                loadRomFile(e.dataTransfer.files[0]);
            }
        });
        dropZone.addEventListener('click', () => {
            document.getElementById('rom').click();
        });

        async function init() {
            const response = await fetch('zgbc.wasm?v=' + Date.now());
            const bytes = await response.arrayBuffer();
            const { instance } = await WebAssembly.instantiate(bytes, {});
            wasm = instance.exports;
        }

        let nextAudioTime = 0;
        let gainNode = null;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new AudioContext({ sampleRate: 44100 });
            gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.5;
            gainNode.connect(audioCtx.destination);
            nextAudioTime = audioCtx.currentTime;
        }

        function playAudio() {
            if (!audioCtx || !audioEnabled || !currentSystem) return;

            const sys = systems[currentSystem];
            const sampleCount = sys.getAudioSamples();
            if (sampleCount === 0) return;

            const audioPtr = wasm.getAudioBuffer();
            const samples = new Int16Array(wasm.memory.buffer, audioPtr, sampleCount);

            const frameCount = Math.floor(sampleCount / 2);
            const buffer = audioCtx.createBuffer(2, frameCount, 44100);
            const left = buffer.getChannelData(0);
            const right = buffer.getChannelData(1);

            for (let i = 0; i < frameCount; i++) {
                left[i] = samples[i * 2] / 32768;
                right[i] = samples[i * 2 + 1] / 32768;
            }

            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(gainNode);

            const now = audioCtx.currentTime;
            if (nextAudioTime < now) nextAudioTime = now;
            source.start(nextAudioTime);
            nextAudioTime += buffer.duration;
        }

        function detectSystem(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            if (ext === 'gb' || ext === 'gbc') return 'gb';
            if (ext === 'nes') return 'nes';
            if (ext === 'sms' || ext === 'sg') return 'sms';
            return null;
        }

        async function loadRomFile(file) {
            if (!wasm) return;

            const system = detectSystem(file.name);
            if (!system) {
                alert('Unsupported file type. Use .gb, .gbc, .nes, or .sms');
                return;
            }

            initAudio();

            const sys = systems[system];
            currentSystem = system;

            // Setup canvas
            canvas.width = sys.width;
            canvas.height = sys.height;
            canvas.style.width = (sys.width * sys.scale) + 'px';
            canvas.style.height = (sys.height * sys.scale) + 'px';

            // Update UI
            dropZone.style.display = 'none';
            canvasContainer.style.display = 'block';
            systemBadge.textContent = sys.label;
            systemBadge.className = 'system-badge ' + sys.class;
            systemBadge.style.display = 'inline-block';

            // Load ROM
            const data = new Uint8Array(await file.arrayBuffer());
            const romPtr = wasm.getRomBuffer();
            new Uint8Array(wasm.memory.buffer).set(data, romPtr);

            sys.init();
            if (sys.loadRom(data.length)) {
                running = true;
                requestAnimationFrame(gameLoop);
            } else {
                alert('Failed to load ROM');
            }
        }

        document.getElementById('rom').addEventListener('change', e => {
            if (e.target.files.length > 0) {
                loadRomFile(e.target.files[0]);
            }
        });

        let lastTime = performance.now();
        let frameCount = 0;
        let lastFrameTime = 0;
        const FRAME_TIME = 1000 / 60;

        function gameLoop(now) {
            if (!running || !currentSystem) return;

            const elapsed = now - lastFrameTime;
            if (elapsed < FRAME_TIME) {
                requestAnimationFrame(gameLoop);
                return;
            }
            lastFrameTime = now - (elapsed % FRAME_TIME);

            const sys = systems[currentSystem];

            sys.setInput(buttons);
            sys.frame();

            // Render
            const framePtr = sys.getFrame();
            const pixels = new Uint32Array(wasm.memory.buffer, framePtr, sys.width * sys.height);
            const imageData = ctx.createImageData(sys.width, sys.height);
            new Uint32Array(imageData.data.buffer).set(pixels);
            ctx.putImageData(imageData, 0, 0);

            playAudio();

            // FPS
            frameCount++;
            if (now - lastTime >= 1000) {
                fpsEl.textContent = `${frameCount} FPS`;
                frameCount = 0;
                lastTime = now;
            }

            requestAnimationFrame(gameLoop);
        }

        init();
    </script>
</body>
</html>
